import"./auth-CgT9UiaM.js";/* empty css                */import"./opastus-B5Ddp_SE.js";document.addEventListener("DOMContentLoaded",function(){U();const e=new Date;S(e.getFullYear(),e.getMonth()),X()});function U(){window.lastSelectedDateEvent=null,window.currentDayHasAbnormalHrv=!1,window.currentSelectedDate=null;const e=document.querySelector("main");if(!e)return;const t=document.createElement("div");t.id="calendar-container",t.className="calendar-container",e.appendChild(t),e.insertBefore(t,document.getElementById("openDiaryBtn, openChartBtn"));const n=document.createElement("div");n.classList.add("calendar-header");const a=document.createElement("button");a.id="prev-month",a.classList.add("month-nav-button"),a.textContent="←";const o=document.createElement("h2");o.id="month-year";const l=document.createElement("button");l.id="next-month",l.classList.add("month-nav-button"),l.textContent="→",n.appendChild(a),n.appendChild(o),n.appendChild(l),t.appendChild(n);const r=document.createElement("div");r.id="calendar-grid",r.classList.add("calendar-grid"),["Ma","Ti","Ke","To","Pe","La","Su"].forEach(i=>{const d=document.createElement("div");d.classList.add("calendar-day-header"),d.textContent=i,r.appendChild(d)});for(let i=0;i<42;i++){const d=document.createElement("div");d.classList.add("calendar-day"),r.appendChild(d)}t.appendChild(r),a.addEventListener("click",function(){const[i,d]=M(),u=new Date(i,d-1,1);S(u.getFullYear(),u.getMonth())}),l.addEventListener("click",function(){const[i,d]=M(),u=new Date(i,d+1,1);S(u.getFullYear(),u.getMonth())})}function S(e,t){const n=["Tammikuu","Helmikuu","Maaliskuu","Huhtikuu","Toukokuu","Kesäkuu","Heinäkuu","Elokuu","Syyskuu","Lokakuu","Marraskuu","Joulukuu"];document.getElementById("month-year").textContent=`${n[t]} ${e}`;const a=document.getElementById("calendar-container");a.dataset.year=e,a.dataset.month=t;const o=new Date(e,t,1),r=new Date(e,t+1,0).getDate(),c=document.querySelectorAll(".calendar-day");c.forEach(s=>{for(s.textContent="",s.style.backgroundColor="",s.classList.remove("current-month","today","selected","abnormal-hrv"),s.removeAttribute("data-date"),s.removeAttribute("data-entries"),s.removeAttribute("data-hrv"),s.style.visibility="hidden";s.firstChild;)s.removeChild(s.firstChild)});let i=o.getDay()-1;i<0&&(i=6);const d=new Date,u=d.getFullYear()===e&&d.getMonth()===t;for(let s=0;s<r;s++){const h=c[i+s],m=s+1;h.style.visibility="visible";const y=document.createElement("span");y.textContent=m,h.appendChild(y),h.classList.add("current-month");const f=(t+1).toString().padStart(2,"0"),b=m.toString().padStart(2,"0"),E=`${e}-${f}-${b}`;if(h.dataset.date=E,u&&d.getDate()===m&&h.classList.add("today"),window.userEntries){const g=window.userEntries.filter(v=>{const p=new Date(v.entry_date),k=new Date(E);return p.getFullYear()===k.getFullYear()&&p.getMonth()===k.getMonth()&&p.getDate()===k.getDate()});if(g.length>0){h.dataset.entries=JSON.stringify(g);const v=document.createElement("div");if(v.style.display="flex",v.style.justifyContent="center",v.style.alignItems="center",v.style.gap="2px",v.style.marginTop="5px",g.some(p=>p.time_of_day==="morning")){const p=document.createElement("img");p.src="/img/sun.png",p.alt="Aamu-merkintä",p.style.width="16px",p.style.height="16px",p.style.zIndex="10",v.appendChild(p)}if(g.some(p=>p.time_of_day==="evening")){const p=document.createElement("img");p.src="/img/moon.png",p.alt="Ilta-merkintä",p.style.width="16px",p.style.height="16px",p.style.zIndex="10",v.appendChild(p)}h.appendChild(v)}}if(window.hrvData&&window.hrvData[E]){const g=window.hrvData[E];g.isAbnormal&&(h.classList.add("abnormal-hrv"),h.dataset.hrv=JSON.stringify(g))}h.addEventListener("click",function(){Q(this)})}}async function Z(e){try{const t=await fetch("http://72.145.13.207:5000/api/kubios/hrv/last-30-measurements",{headers:{Authorization:`Bearer ${e}`}});if(!t.ok)throw new Error(`HRV-arvojen haku epäonnistui: ${t.status} ${t.statusText}`);const n=await t.json();console.log("HRV-arvot haettu:",n),window.hrvData={},n.forEach(a=>{if(!a.daily_result)return;const l=new Date(a.daily_result).toISOString().split("T")[0],r=a.rmssd<20||a.rmssd>90,c=a.sdnn<40||a.sdnn>130;window.hrvData[l]={rmssd:a.rmssd,sdnn:a.sdnn,heart_rate:a.heart_rate,mean_rr:a.mean_rr,pns_index:a.pns_index,sns_index:a.sns_index,isAbnormal:r||c,rmssdAbnormal:r,sdnnAbnormal:c}}),console.log("HRV-data käsitelty:",window.hrvData)}catch(t){console.error("Virhe HRV-datan haussa:",t),window.hrvData={}}}function Q(e){if(e.classList.contains("selected"))return;document.querySelectorAll(".calendar-day.selected").forEach(i=>{i.classList.remove("selected")}),e.classList.add("selected");const t=e.dataset.date;if(!t)return;const n=e.dataset.lastSelectedTime,a=Date.now();if(n&&a-parseInt(n)<500)return;e.dataset.lastSelectedTime=a;const o=e.dataset.entries,l=o?JSON.parse(o):[],r=e.dataset.hrv?JSON.parse(e.dataset.hrv):null;if(window.lastSelectedDateEvent===t)return;window.lastSelectedDateEvent=t;const c=new CustomEvent("selectedDateChanged",{bubbles:!1,detail:{date:t,entries:l,hrvData:r}});setTimeout(()=>{window.dispatchEvent(c)},10)}async function X(){try{const e=localStorage.getItem("user");if(!e){console.error("Käyttäjätietoja ei löydy"),window.userEntries=[],S(new Date().getFullYear(),new Date().getMonth());return}const n=JSON.parse(e).token;if(!n){console.error("Token puuttuu käyttäjätiedoista"),window.userEntries=[],S(new Date().getFullYear(),new Date().getMonth());return}const a=await fetch("http://72.145.13.207:5000/api/entries/user",{headers:{Authorization:`Bearer ${n}`}});if(!a.ok)throw new Error(`Merkintöjen haku epäonnistui: ${a.status} ${a.statusText}`);const o=await a.json();console.log("Käyttäjän merkinnät haettu:",o),window.userEntries=o||[],await Z(n);const[l,r]=M();S(l,r)}catch(e){console.error("Virhe merkintöjen haussa:",e);let t=document.getElementById("calendar-notification");if(!t){t=document.createElement("div"),t.id="calendar-notification",t.classList.add("calendar-notification");const n=document.getElementById("calendar-container");n&&n.parentNode.insertBefore(t,n)}t.textContent="Merkintöjen haku epäonnistui: "+e.message,window.userEntries=[],window.hrvData={},S(new Date().getFullYear(),new Date().getMonth())}}function M(){const e=document.getElementById("calendar-container"),t=e?parseInt(e.dataset.year):new Date().getFullYear(),n=e?parseInt(e.dataset.month):new Date().getMonth();return[t,n]}document.addEventListener("DOMContentLoaded",function(){let e=!1,t=[];window.addEventListener("selectedDateChanged",function(a){if(e){t.push(a);return}e=!0,n(a),setTimeout(()=>{if(e=!1,t.length>0){const o=t.pop();t=[],window.dispatchEvent(o)}},500)});function n(a){console.log("Käsitellään päivämäärävalinta:",a.detail.date);const{date:o,hrvData:l}=a.detail;if(window.currentSelectedDate=o,l&&(l.isAbnormal||l.rmssdAbnormal||l.sdnnAbnormal)){window.currentDayHasAbnormalHrv=!0;const r=document.getElementById("generateHrvReportBtn");r&&r.classList.contains("hidden")&&(r.classList.remove("hidden"),console.log("HRV-raporttipainike näytetään - poikkeava arvo"))}else{window.currentDayHasAbnormalHrv=!1;const r=document.getElementById("generateHrvReportBtn");r&&!r.classList.contains("hidden")&&(r.classList.add("hidden"),console.log("HRV-raporttipainike piilotetaan - ei poikkeavaa arvoa"))}}});console.log("diary.js ladattu");function ee(){const e=JSON.parse(localStorage.getItem("user"));return e?e.token:null}let A=null,w=[];const $={"18-25":{rmssd:{min:25,max:100},sdnn:{min:50,max:150}},"26-35":{rmssd:{min:20,max:90},sdnn:{min:40,max:130}},"36-45":{rmssd:{min:15,max:80},sdnn:{min:30,max:110}},"46-56":{rmssd:{min:10,max:60},sdnn:{min:20,max:80}}};document.addEventListener("DOMContentLoaded",()=>{const e=ee();if(console.log("Haettu token:",e),!e){alert("Et ole kirjautunut sisään."),window.location.href="/index.html";return}ae(e),ne(),te()});function te(){const e=document.getElementById("calendar-container");if(!e||document.querySelector(".calendar-legend"))return;const t=document.createElement("div");t.classList.add("calendar-legend"),[{icon:"/img/sun.png",text:"Aamu-merkintä",alt:"Aurinko"},{icon:"/img/moon.png",text:"Ilta-merkintä",alt:"Kuu"},{class:"abnormal-hrv",text:"Poikkeava HRV",type:"box"}].forEach(a=>{const o=document.createElement("div");if(o.classList.add("legend-item"),a.type==="box"){const r=document.createElement("span");r.style.width="15px",r.style.height="15px",r.style.backgroundColor="#ffcdd2",r.style.border="1px solid #e57373",o.appendChild(r)}else{const r=document.createElement("img");r.src=a.icon,r.alt=a.alt,r.style.width="16px",r.style.height="16px",o.appendChild(r)}const l=document.createElement("span");l.textContent=a.text,o.appendChild(l),t.appendChild(o)}),e.appendChild(t)}function ne(){const e=document.getElementById("chartModal"),t=document.getElementById("openChartBtn"),n=document.querySelector("#chartModal .close-modal"),a=document.getElementById("btn7days"),o=document.getElementById("btn30days"),l=document.getElementById("hrvPieChart"),r=document.getElementById("lineChartGrid"),c=document.querySelector("#chartHeaderTitle"),i=document.getElementById("diaryModal"),d=document.getElementById("openDiaryBtn"),u=document.querySelector("#diaryModal .close-modal");P(e,"chart-modal-overlay"),P(i,"diary-modal-overlay"),t&&t.addEventListener("click",async()=>{e.style.display="block",document.getElementById("chart-modal-overlay").style.display="block",c.textContent="HRV-arvot (Viimeisin mittaus)",l.style.display="block",r&&(r.innerHTML="");try{const m=JSON.parse(localStorage.getItem("user")),y=await fetch("http://72.145.13.207:5000/api/kubios/hrv/last-30-measurements",{headers:{Authorization:`Bearer ${m.token}`}});if(!y.ok)throw new Error("Failed to fetch HRV data");if(w=await y.json(),!w||w.length===0){console.warn("No HRV data available");return}const f=w[w.length-1];N(f),F(w)}catch(m){console.error("Data loading error:",m),alert("Ei HRV-dataa saatavilla")}}),d&&d.addEventListener("click",()=>{i.style.display="block",document.getElementById("diary-modal-overlay").style.display="block"}),n&&n.addEventListener("click",()=>{e.style.display="none",document.getElementById("chart-modal-overlay").style.display="none"}),u&&u.addEventListener("click",()=>{i.style.display="none",document.getElementById("diary-modal-overlay").style.display="none"});const s=document.getElementById("chart-modal-overlay"),h=document.getElementById("diary-modal-overlay");if(s&&s.addEventListener("click",()=>{e.style.display="none",s.style.display="none",console.log("Chart modaali suljettu klikkaamalla taustaa")}),h&&h.addEventListener("click",()=>{i.style.display="none",h.style.display="none",console.log("Diary modaali suljettu klikkaamalla taustaa")}),e){const m=e.querySelector(".Chartmodal-content");m&&m.addEventListener("click",function(y){y.stopPropagation()})}if(i){const m=i.querySelector(".modal-content");m&&m.addEventListener("click",function(y){y.stopPropagation()})}a&&a.addEventListener("click",async()=>{l&&(l.style.display="none"),r&&(r.innerHTML=""),c&&(c.textContent="HRV-arvot (viimeiset 7 päivää)");try{const m=JSON.parse(localStorage.getItem("user")),y=await fetch("http://72.145.13.207:5000/api/kubios/hrv/last-7-measurements",{headers:{Authorization:`Bearer ${m.token}`}});if(!y.ok)throw new Error("Failed to fetch HRV data");if(w=await y.json(),console.log("7 päivän data:",w),!w||w.length===0){console.warn("No HRV data available for last 7 days"),alert("Ei HRV-dataa saatavilla viimeiselle 7 päivälle");return}q(7),F(w)}catch(m){console.error("Data loading error:",m),alert("Ei HRV-dataa saatavilla")}}),o&&o.addEventListener("click",async()=>{l&&(l.style.display="none"),r&&(r.innerHTML=""),c&&(c.textContent="HRV-arvot (viimeiset 30 päivää)");try{const m=JSON.parse(localStorage.getItem("user")),y=await fetch("http://72.145.13.207:5000/api/kubios/hrv/last-30-measurements",{headers:{Authorization:`Bearer ${m.token}`}});if(!y.ok)throw new Error("Failed to fetch HRV data");if(w=await y.json(),console.log("30 päivän data:",w),!w||w.length===0){console.warn("No HRV data available for last 30 days"),alert("Ei HRV-dataa saatavilla viimeiselle 30 päivälle");return}q(30),F(w)}catch(m){console.error("Data loading error:",m),alert("Ei HRV-dataa saatavilla")}})}function F(e){if(!e||!e.length)return;let t="26-35";try{const a=JSON.parse(localStorage.getItem("user"));if(a&&a.user&&a.user.birthdate){const o=new Date(a.user.birthdate),l=new Date;let r=l.getFullYear()-o.getFullYear();const c=l.getMonth()-o.getMonth();(c<0||c===0&&l.getDate()<o.getDate())&&r--,r>=18&&r<=25?t="18-25":r>=26&&r<=35?t="26-35":r>=36&&r<=45?t="36-45":r>=46&&r<=56&&(t="46-56")}}catch(a){console.error("Virhe käyttäjän iän laskemisessa:",a)}console.log("Käytetään ikäryhmää:",t);const n=$[t];window.hrvData={},e.forEach(a=>{if(!a.daily_result)return;const o=new Date(a.daily_result).toISOString().split("T")[0],l=a.rmssd<n.rmssd.min||a.rmssd>n.rmssd.max,r=a.sdnn<n.sdnn.min||a.sdnn>n.sdnn.max,c=l||r;window.hrvData[o]={rmssd:a.rmssd,sdnn:a.sdnn,heart_rate:a.heart_rate,mean_rr:a.mean_rr,pns_index:a.pns_index,sns_index:a.sns_index,isAbnormal:c,rmssdAbnormal:l,sdnnAbnormal:r};const i=document.querySelector(`.calendar-day[data-date="${o}"]`);i&&c&&(i.classList.add("abnormal-hrv"),i.dataset.hrv=JSON.stringify(window.hrvData[o]),console.log(`Merkitty päivä ${o} poikkeavaksi HRV-arvoksi. RMSSD: ${a.rmssd}, SDNN: ${a.sdnn}`))}),console.log("HRV-data käsitelty kalenteria varten:",window.hrvData)}function P(e,t){if(!e||document.getElementById(t))return;const n=document.createElement("div");n.id=t,n.style.position="fixed",n.style.top="0",n.style.left="0",n.style.width="100%",n.style.height="100%",n.style.backgroundColor="rgba(0, 0, 0, 0)",n.style.zIndex="999",n.style.display="none",document.body.appendChild(n)}function ae(e){const t=document.getElementById("diaryForm"),n=document.querySelector("#submit-button"),a="http://72.145.13.207:5000/api/entries/insert";j(e),t&&t.addEventListener("submit",async o=>{if(o.preventDefault(),L(n,!0),!z("time")){alert("Valitse kirjauksen ajankohta (Aamu/Ilta)"),L(n,!1);return}const l={entry_date:new Date().toISOString().split("T")[0],time_of_day:z("time"),sleep_duration:parseInt(document.getElementById("sleepRange").value,10),current_mood:parseInt(document.getElementById("moodRange").value,10),sleep_notes:Y(0),activity:Y(1)};localStorage.setItem("lastEntryData",JSON.stringify(l)),console.log("Lähetetään lomake:",l);try{const r=await fetch(a,{method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${e}`},body:JSON.stringify(l)}),c=await r.json(),i=document.getElementById("saveMessageContainer"),d=document.getElementById("saveResponse");r.ok?(d.textContent="Päiväkirjamerkintä tallennettu!",i.className="success show",T(),H(),j(e),oe(n),setTimeout(()=>{i.className="",d.textContent="",setTimeout(()=>{se()},500)},1500)):(d.textContent="Tallennus epäonnistui: "+(c.message||"Tuntematon virhe"),i.className="error show",console.error("Palvelimen vastaus:",c),setTimeout(()=>{i.className="",d.textContent=""},2e3))}catch(r){alert("Palvelinvirhe. Yritä myöhemmin."),console.error("[TALLENNUS VIRHE]",r)}L(n,!1)}),window.addEventListener("selectedDateChanged",async o=>{const{date:l,entries:r,hrvData:c}=o.detail,i=JSON.parse(localStorage.getItem("user"));i.user_id||i.id||i.userId;const d=i.token;if(r&&r.length>0)if(K(r[r.length-1]),c)_(c);else try{await B(d,l)}catch(u){console.error("HRV-datan haku epäonnistui:",u)}else if(T(),c)_(c);else try{await B(d,l)}catch(u){console.error("HRV-datan haku epäonnistui tyhjälle päivälle:",u)}}),le()}function _(e){var a,o,l,r,c,i;if(!e)return;x("hrv-syke",((a=e.heart_rate)==null?void 0:a.toFixed(2))||"-"),x("hrv-rmssd",((o=e.rmssd)==null?void 0:o.toFixed(2))||"-"),x("hrv-meanrr",((l=e.mean_rr)==null?void 0:l.toFixed(2))||"-"),x("hrv-sdnn",((r=e.sdnn)==null?void 0:r.toFixed(2))||"-"),x("hrv-pns",((c=e.pns_index)==null?void 0:c.toFixed(2))||"-"),x("hrv-sns",((i=e.sns_index)==null?void 0:i.toFixed(2))||"-");const t=document.getElementById("hrv-rmssd"),n=document.getElementById("hrv-sdnn");t&&(t.style.backgroundColor=e.rmssdAbnormal?"#ffcdd2":"#bebebe"),n&&(n.style.backgroundColor=e.sdnnAbnormal?"#ffcdd2":"#bebebe")}function oe(e){e&&(e.classList.add("success"),setTimeout(()=>e.classList.remove("success"),2e3))}function K(e){document.querySelectorAll('input[name="time"]').forEach(l=>{l.checked=l.value===(e.time_of_day==="morning"?"morning":"evening")});const n=document.getElementById("sleepRange");n&&(n.value=e.sleep_duration||3,C(n));const a=document.getElementById("moodRange");a&&(a.value=e.current_mood||3,C(a));const o=document.querySelectorAll("textarea");o.length>=1&&(o[0].value=e.sleep_notes||"",o.length>1&&(o[1].value=e.activity||""))}async function j(e){const t=new Date().toISOString().split("T")[0];console.log("📡 Haetaan HRV päivälle:",t);try{const n=await fetch(`http://72.145.13.207:5000/api/kubios/hrv/by-date/${t}`,{headers:{Authorization:`Bearer ${e}`}});if(n.status===401){alert("Istunto vanhentunut. Kirjaudu uudelleen."),window.location.href="/index.html";return}if(!n.ok){console.warn("[HRV HAKU] status:",n.status);return}const a=await n.json();console.log(a),a.results.sort((l,r)=>new Date(r.create_timestamp)-new Date(l.create_timestamp));const o=a.results[0];if(!o){console.warn("No HRV data found for today");return}x("hrv-syke",o.heart_rate.toFixed(2)),x("hrv-rmssd",o.rmssd.toFixed(2)),x("hrv-meanrr",o.mean_rr.toFixed(2)),x("hrv-sdnn",o.sdnn.toFixed(2)),x("hrv-pns",o.pns_index.toFixed(2)),x("hrv-sns",o.sns_index.toFixed(2)),await re(e)}catch(n){console.error("[HRV VIRHE]",n.message)}}async function re(e){try{const t=await fetch("http://72.145.13.207:5000/api/kubios/hrv/last-30-measurements",{headers:{Authorization:`Bearer ${e}`}});if(!t.ok){console.warn("[HRV kuukausihaku]",t.status);return}const n=await t.json();F(n)}catch(t){console.error("[HRV kuukausihaku virhe]",t.message)}}async function B(e,t){console.log("📡 Haetaan HRV päivälle:",t);try{const n=await fetch(`http://72.145.13.207:5000/api/kubios/hrv/by-date/${t}`,{headers:{Authorization:`Bearer ${e}`}});if(n.status===401){alert("Istunto vanhentunut. Kirjaudu uudelleen."),window.location.href="/index.html";return}if(!n.ok){console.warn("[HRV HAKU] status:",n.status),H();return}const a=await n.json();if(console.log(a),!a.results||!a.results[0]){console.warn("No HRV data found for the selected date"),H();return}const o=a.results[0],l=JSON.parse(localStorage.getItem("user"));let r="26-35";if(l&&l.user&&l.user.birthdate){const h=new Date(l.user.birthdate),m=new Date;let y=m.getFullYear()-h.getFullYear();const f=m.getMonth()-h.getMonth();(f<0||f===0&&m.getDate()<h.getDate())&&y--,y>=18&&y<=25?r="18-25":y>=26&&y<=35?r="26-35":y>=36&&y<=45?r="36-45":y>=46&&y<=56&&(r="46-56")}const c=$[r],i=o.rmssd<c.rmssd.min||o.rmssd>c.rmssd.max,d=o.sdnn<c.sdnn.min||o.sdnn>c.sdnn.max,u={heart_rate:o.heart_rate,rmssd:o.rmssd,mean_rr:o.mean_rr,sdnn:o.sdnn,pns_index:o.pns_index,sns_index:o.sns_index,isAbnormal:i||d,rmssdAbnormal:i,sdnnAbnormal:d};_(u),window.hrvData||(window.hrvData={}),window.hrvData[t]=u;const s=document.querySelector(`.calendar-day[data-date="${t}"]`);s&&(u.isAbnormal?s.classList.add("abnormal-hrv"):s.classList.remove("abnormal-hrv"),s.dataset.hrv=JSON.stringify(u))}catch(n){console.error("[HRV VIRHE]",n.message),H()}}function T(){document.querySelectorAll('input[name="time"]').forEach(o=>o.checked=!1);const t=document.getElementById("sleepRange"),n=document.getElementById("moodRange");t&&(t.value=3,C(t)),n&&(n.value=3,C(n)),document.querySelectorAll("textarea").forEach(o=>o.value=""),H()}function x(e,t){const n=document.getElementById(e);n&&(n.textContent=t??"-")}function z(e){var t;return((t=document.querySelector(`input[name="${e}"]:checked`))==null?void 0:t.value)||""}function Y(e){var t;return((t=document.querySelectorAll("textarea")[e])==null?void 0:t.value)||""}function H(){const e=document.getElementById("hrv-rmssd"),t=document.getElementById("hrv-sdnn");e&&(e.style.backgroundColor="#bebebe"),t&&(t.style.backgroundColor="#bebebe"),["hrv-syke","hrv-rmssd","hrv-meanrr","hrv-sdnn","hrv-pns","hrv-sns"].forEach(n=>x(n,"-"))}function L(e,t){e&&(e.disabled=t,e.textContent=t?"Tallennetaan...":"Tallenna")}function C(e){if(!e)return;const t=parseInt(e.value,10);let n="#477668";(e.id==="sleepRange"||e.id==="moodRange")&&(t===1?n="red":t===2?n="coral":t===3?n="orange":t===4?n="lightgreen":t===5&&(n="green")),e.style.setProperty("--thumb-color",n)}function N(e){const t=document.getElementById("hrvPieChart");if(!t)return;const n=[e.heart_rate,e.rmssd,e.mean_rr,e.sdnn,e.pns_index,e.sns_index],a=Math.max(...n),o=n.map(c=>c/a*100),l=["Syke","RMSSD","Mean RR","SDNN","PNS Index","SNS Index"],r=["red","green","blue","purple","orange","brown"];A&&A.destroy(),A=new Chart(t.getContext("2d"),{type:"polarArea",data:{labels:l,datasets:[{data:o,backgroundColor:r,borderColor:"#fff",borderWidth:2}]},options:{responsive:!0,plugins:{title:{display:!0}}}})}function q(e){const t=document.getElementById("lineChartGrid");if(!t||!w)return;console.log(`Drawing line charts for ${e} days with data:`,w),t.innerHTML="";const n=w.slice(-e),a=n.map(l=>l.daily_result?new Date(l.daily_result).toLocaleDateString("fi-FI"):"Tuntematon päivä");[{key:"heart_rate",label:"Syke",color:"red"},{key:"rmssd",label:"RMSSD",color:"green"},{key:"mean_rr",label:"Mean RR",color:"blue"},{key:"sdnn",label:"SDNN",color:"purple"},{key:"pns_index",label:"PNS-indeksi",color:"orange"},{key:"sns_index",label:"SNS-indeksi",color:"brown"}].forEach(l=>{const r=document.createElement("div");r.classList.add("chart-card");const c=document.createElement("canvas");c.width=400,c.height=200,r.appendChild(c),t.appendChild(r);let i="26-35";const d=JSON.parse(localStorage.getItem("user"));if(d&&d.user&&d.user.birthdate){const h=new Date(d.user.birthdate),m=new Date;let y=m.getFullYear()-h.getFullYear();const f=m.getMonth()-h.getMonth();(f<0||f===0&&m.getDate()<h.getDate())&&y--,y>=18&&y<=25?i="18-25":y>=26&&y<=35?i="26-35":y>=36&&y<=45?i="36-45":y>=46&&y<=56&&(i="46-56")}const u=$[i];let s=[];l.key==="rmssd"?s=[{value:u.rmssd.min,label:"Min",color:"red"},{value:u.rmssd.max,label:"Max",color:"red"}]:l.key==="sdnn"&&(s=[{value:u.sdnn.min,label:"Min",color:"red"},{value:u.sdnn.max,label:"Max",color:"red"}]),new Chart(c.getContext("2d"),{type:"line",data:{labels:a,datasets:[{label:l.label,data:n.map(h=>h[l.key]),borderColor:l.color,backgroundColor:"transparent",tension:.4,fill:!1,pointRadius:3}]},options:{responsive:!0,maintainAspectRatio:!1,plugins:{title:{display:!0,text:`${l.label} – Viimeiset ${e} päivää`}},scales:{y:{beginAtZero:!1,afterDataLimits:h=>{var m,y;if(s.length>0){const f=Math.min(h.min,((m=u[l.key])==null?void 0:m.min)||h.min),b=Math.max(h.max,((y=u[l.key])==null?void 0:y.max)||h.max);h.min=f-(b-f)*.1,h.max=b+(b-f)*.1}}}},plugins:[{afterDraw:h=>{if(s.length>0){const m=h.ctx,y=h.scales.y;s.forEach(f=>{const b=y.getPixelForValue(f.value);m.save(),m.beginPath(),m.moveTo(h.chartArea.left,b),m.lineTo(h.chartArea.right,b),m.lineWidth=1,m.strokeStyle=f.color,m.setLineDash([5,5]),m.stroke(),m.fillStyle=f.color,m.font="12px Arial",m.fillText(f.label,h.chartArea.left+5,b-5),m.restore()})}}}]}})})}function se(){console.log("Avataan HRV-kaaviomodaali");const e=document.getElementById("diaryModal");if(e){e.style.display="none";const t=document.getElementById("diary-modal-overlay");t&&(t.style.display="none"),console.log("Päiväkirjamodaali suljettu")}setTimeout(()=>{const t=document.getElementById("chartModal");if(!t){console.error("chartModal elementtiä ei löydy");return}t.style.display="block";const n=document.getElementById("chart-modal-overlay");n?n.style.display="block":console.error("chart-modal-overlay elementtiä ei löydy");const a=new Date().toISOString().split("T")[0],o=window.hrvData?window.hrvData[a]:null,l=document.querySelector("#chartHeaderTitle");l&&(l.textContent="HRV-arvot (uusin päivä)");const r=document.getElementById("hrvPieChart");r&&(r.style.display="block");const c=document.getElementById("lineChartGrid");c&&(c.innerHTML="");const i=document.getElementById("hrv-warning");if(i&&i.remove(),o&&(o.isAbnormal||o.rmssdAbnormal||o.sdnnAbnormal)){console.log("Poikkeavia HRV-arvoja havaittu, näytetään varoitus");const d=document.createElement("div");d.id="hrv-warning",d.style.backgroundColor="#FFA500",d.style.color="#000",d.style.padding="10px",d.style.marginBottom="15px",d.style.borderRadius="5px",d.style.textAlign="center",d.style.fontWeight="bold",d.textContent="Poikkeavia arvoja mittauksessa. Suosittelemme tekemään raportin tästä.";const u=document.createElement("button");u.textContent="Luo HRV-raportti ammattilaiselle",u.style.marginTop="10px",u.style.padding="8px 15px",u.style.backgroundColor="#f44336",u.style.color="white",u.style.border="none",u.style.borderRadius="4px",u.style.cursor="pointer",typeof generateHrvPdfReport=="function"?u.addEventListener("click",generateHrvPdfReport):console.error("generateHrvPdfReport-funktiota ei löydy"),d.appendChild(document.createElement("br")),d.appendChild(u);const s=document.querySelector(".Chartmodal-content");s?s.insertBefore(d,s.firstChild):console.error("Modal content -elementtiä ei löydy"),typeof window.currentDayHasAbnormalHrv<"u"&&(window.currentDayHasAbnormalHrv=!0,window.currentSelectedDate=a)}if(o&&typeof N=="function"){const d={heart_rate:o.heart_rate,rmssd:o.rmssd,mean_rr:o.mean_rr,sdnn:o.sdnn,pns_index:o.pns_index,sns_index:o.sns_index};N(d)}console.log("HRV-kaaviomodaali avattu")},300)}document.addEventListener("DOMContentLoaded",()=>{document.querySelectorAll(".slider").forEach(t=>{t.addEventListener("input",()=>C(t)),C(t)})});function le(){const e=new Date().toISOString().split("T")[0],n=(window.userEntries||[]).filter(o=>o.entry_date===e),a=new CustomEvent("selectedDateChanged",{detail:{date:e,entries:n,hrvData:window.hrvData?window.hrvData[e]:null}});window.dispatchEvent(a)}function ie(e,t){document.getElementById("day-details-panel");const n=document.getElementById("no-entry-text"),a=document.getElementById("hrv-details"),o=document.getElementById("diary-entry-details");n.classList.add("hidden"),a.classList.add("hidden"),o.classList.add("hidden"),document.getElementById("detail-heart-rate").textContent="-",document.getElementById("detail-rmssd").textContent="-",document.getElementById("detail-sdnn").textContent="-",document.getElementById("detail-sleep").textContent="-/5",document.getElementById("detail-mood").textContent="-/5",document.getElementById("sleep-notes-detail").textContent="",document.getElementById("activity-notes-detail").textContent="";const l=document.querySelector(".time-icon"),r=document.querySelector(".detail-time");l&&(l.style.backgroundImage=""),r&&(r.textContent="");const c=new Date(e).toLocaleDateString("fi-FI");if(document.querySelector(".day-details-panel h3").textContent=`Päiväkirja - ${c}`,!t||!t.entries&&!t.hrvData){n.textContent="Ei merkintöjä tälle päivälle",n.classList.remove("hidden");return}if(t.hrvData&&(document.getElementById("detail-heart-rate").textContent=t.hrvData.heart_rate?t.hrvData.heart_rate.toFixed(1):"-",document.getElementById("detail-rmssd").textContent=t.hrvData.rmssd?t.hrvData.rmssd.toFixed(1):"-",document.getElementById("detail-sdnn").textContent=t.hrvData.sdnn?t.hrvData.sdnn.toFixed(1):"-",a.classList.remove("hidden")),t.entries&&t.entries.length>0){const i=t.entries[0];document.querySelector(".time-icon");const d=document.querySelector(".detail-time");i.time_of_day==="morning"?d.textContent="Aamu":d.textContent="Ilta";const u=i.sleep_duration||0,s=i.current_mood||0;document.getElementById("detail-sleep").textContent=`${Math.round(u)}/5`,document.getElementById("detail-mood").textContent=`${Math.round(s)}/5`;const h=document.getElementById("sleep-notes-detail");h.textContent=i.sleep_notes||"";const m=document.getElementById("activity-notes-detail");m.textContent=i.activity||"",o.classList.remove("hidden")}}window.addEventListener("selectedDateChanged",function(e){const{date:t,entries:n,hrvData:a}=e.detail;ie(t,{entries:n,hrvData:a});const o=JSON.parse(localStorage.getItem("user"));o.user_id||o.id||o.userId;const l=o.token;if(n&&n.length>0)if(K(n[n.length-1]),a)_(a);else try{B(l,t)}catch(r){console.error("HRV-datan haku epäonnistui:",r)}else if(T(),a)_(a);else try{B(l,t)}catch(r){console.error("HRV-datan haku epäonnistui tyhjälle päivälle:",r)}});window.generateHrvPdfReport=G;window.HRV_THRESHOLDS={"18-25":{rmssd:{min:25,max:100},sdnn:{min:50,max:150}},"26-35":{rmssd:{min:20,max:90},sdnn:{min:40,max:130}},"36-45":{rmssd:{min:15,max:80},sdnn:{min:30,max:110}},"46-56":{rmssd:{min:10,max:60},sdnn:{min:20,max:80}}};function R(e,t="info"){let n=document.getElementById("status-message");n||(n=document.createElement("div"),n.id="status-message",n.style.position="fixed",n.style.top="20px",n.style.right="20px",n.style.padding="10px 20px",n.style.borderRadius="5px",n.style.zIndex="1000",n.style.boxShadow="0 2px 4px rgba(0,0,0,0.2)",document.body.appendChild(n)),n.textContent=e,t==="error"?(n.style.backgroundColor="#f44336",n.style.color="white"):t==="success"?(n.style.backgroundColor="#4CAF50",n.style.color="white"):(n.style.backgroundColor="#2196F3",n.style.color="white"),n.style.display="block",setTimeout(()=>{n.style.display="none"},3e3)}function V(e){let t;if(typeof e=="string"){if(e.includes("T")&&(e=e.split("T")[0]),/^\d{4}-\d{2}-\d{2}$/.test(e))return e;t=new Date(e)}else if(e instanceof Date)t=e;else return console.error("Invalid date input:",e),null;if(isNaN(t.getTime()))return console.error("Invalid date:",e),null;const n=t.getFullYear(),a=String(t.getMonth()+1).padStart(2,"0"),o=String(t.getDate()).padStart(2,"0");return`${n}-${a}-${o}`}async function J(e){try{const t=JSON.parse(localStorage.getItem("user"));if(!t||!t.token)throw new Error("User token not found");const n=`http://72.145.13.207:5000/api/kubios/hrv/last-${e>7?"30":"7"}-measurements`;console.log(`Fetching HRV data from: ${n}`);const a=await fetch(n,{headers:{Authorization:`Bearer ${t.token}`}});if(!a.ok)throw new Error(`HTTP error! status: ${a.status}`);const o=await a.json();return console.log(`Fetched ${e} days data:`,o),o}catch(t){return console.error(`Error fetching ${e} days data:`,t),[]}}function de(){var i,d;if(!document.getElementById("diaryForm"))return null;const t=u=>{var s;return((s=document.querySelector(`input[name="${u}"]:checked`))==null?void 0:s.value)||""},n=document.querySelectorAll("textarea"),a=((i=n[0])==null?void 0:i.value)||"",o=((d=n[1])==null?void 0:d.value)||"",l=document.getElementById("sleepRange"),r=document.getElementById("moodRange"),c={entry_date:new Date().toISOString().split("T")[0],time_of_day:t("time"),sleep_duration:l?parseFloat(l.value):3,current_mood:r?parseFloat(r.value):3,sleep_notes:a,activity:o};return console.log("GetFormData returns:",c),c}let W=null;document.addEventListener("DOMContentLoaded",()=>{console.log("HRV-report script loaded");const e=document.getElementById("generateHrvReportBtn");e&&(console.log("PDF report button found"),e.addEventListener("click",G)),window.addEventListener("selectedDateChanged",function(t){console.log("Date selection event received:",t.detail);const{date:n,hrvData:a}=t.detail;W=n,a&&(a.isAbnormal||a.rmssdAbnormal||a.sdnnAbnormal)?(ce(),console.log("Showing report button - abnormal HRV found")):(ue(),console.log("Hiding report button - no abnormal HRV"))})});function ce(){const e=document.getElementById("generateHrvReportBtn");e&&e.classList.remove("hidden")}function ue(){const e=document.getElementById("generateHrvReportBtn");e&&e.classList.add("hidden")}async function G(){var a;console.log("PDF generation started");const e=W||window.currentSelectedDate;if(!e){R("Valitse ensin päivä kalenterista","error");return}const t=new Date().toISOString().split("T")[0],n=V(e)===t;try{const o=V(e);console.log("Generating PDF for date:",o),R("Luodaan PDF-raporttia...","info");const l=window.hrvData?window.hrvData[o]:null;if(!l){console.error("HRV data not found for the selected date:",o),R("HRV-tietoja ei löydy valitulle päivälle","error");return}const r=JSON.parse(localStorage.getItem("user")),c=((a=r==null?void 0:r.user)==null?void 0:a.given_name)||"Käyttäjä",d=new Date(o).toLocaleDateString("fi-FI"),{jsPDF:u}=window.jspdf,s=new u;s.setFont("helvetica","bold"),s.setFontSize(20),s.text("HRV-raportti",105,20,{align:"center"}),s.setFont("helvetica","normal"),s.setFontSize(12),s.text(`Potilaan nimi: ${c}`,20,40),s.text(`Raportin päivämäärä: ${d}`,20,50),s.setLineWidth(.5),s.line(20,55,190,55),s.setFont("helvetica","bold"),s.setFontSize(16),s.text("HRV-arvot päivältä",20,70),s.setFont("helvetica","normal"),s.setFontSize(12);const h=[["Mittaus","Arvo","Normaali alue","Tila"],["Syke",l.heart_rate.toFixed(2),"60 - 80 bpm",""],["RMSSD",l.rmssd.toFixed(2),"20 - 90 ms",l.rmssdAbnormal?"POIKKEAVA":"Normaali"],["Mean RR",l.mean_rr.toFixed(2),"750 - 1000 ms",""],["SDNN",l.sdnn.toFixed(2),"40 - 130 ms",l.sdnnAbnormal?"POIKKEAVA":"Normaali"],["PNS-indeksi",l.pns_index.toFixed(2),"",""],["SNS-indeksi",l.sns_index.toFixed(2),"",""]],m={theme:"grid",headStyles:{fillColor:[71,118,104]},styles:{overflow:"linebreak"},columnStyles:{0:{cellWidth:40},1:{cellWidth:30},2:{cellWidth:50},3:{cellWidth:40}}},y={};l.rmssdAbnormal&&(y[2]={fillColor:[255,200,200]}),l.sdnnAbnormal&&(y[4]={fillColor:[255,200,200]}),s.autoTable({head:[h[0]],body:h.slice(1),startY:75,...m,rowStyles:y});let f=null;if(n){const g=localStorage.getItem("lastEntryData");g?(f=JSON.parse(g),console.log("Using saved form data from localStorage:",f),localStorage.removeItem("lastEntryData")):(f=de(),console.log("Using form data directly:",f))}else{const g=document.querySelector(`.calendar-day[data-date="${o}"]`);if(g&&g.dataset.entries)try{const v=JSON.parse(g.dataset.entries);v&&v.length>0&&(f=v[v.length-1],console.log("Found entry from calendar element:",f))}catch(v){console.error("Error parsing entries from calendar:",v)}if(!f&&window.userEntries&&Array.isArray(window.userEntries)){const v=window.userEntries.filter(p=>!p||!p.entry_date?!1:V(p.entry_date)===o);v.length>0&&(f=v[v.length-1],console.log("Found entry in userEntries:",f))}}if(f){let g=s.lastAutoTable.finalY+20;s.setFont("helvetica","bold"),s.setFontSize(16),s.text("Päiväkirjamerkintä",20,g),g+=10,s.setFont("helvetica","normal"),s.setFontSize(12);const v=f.time_of_day==="morning"?"Aamu":"Ilta";s.setFont("helvetica","bold"),s.text("Ajankohta:",20,g),s.setFont("helvetica","normal"),s.text(v,120,g),g+=10;let p=f.sleep_duration;typeof p!="number"&&(p=parseFloat(p)||0),s.setFont("helvetica","bold"),s.text("Unen laatu (1-5):",20,g),s.setFont("helvetica","normal");let k="Ei tietoa";if(p!=null&&(k=Number.isInteger(p)?String(p):p.toFixed(1)),s.text(`${k}/5`,120,g),f.sleep_notes&&f.sleep_notes.trim()!==""){g+=10,s.setFont("helvetica","bold"),s.text("Unen lisätiedot:",20,g),s.setFont("helvetica","normal");const I=s.splitTextToSize(f.sleep_notes,150);s.text(I,120,g),g+=I.length*7}else g+=10;let D=f.current_mood;typeof D!="number"&&(D=parseFloat(D)||0),s.setFont("helvetica","bold"),s.text("Mieliala (1-5):",20,g),s.setFont("helvetica","normal");let O="Ei tietoa";if(D!=null&&(O=Number.isInteger(D)?String(D):D.toFixed(1)),s.text(`${O}/5`,120,g),f.activity&&f.activity.trim()!==""){g+=10,s.setFont("helvetica","bold"),s.text("Mielialan lisätiedot:",20,g),s.setFont("helvetica","normal");const I=s.splitTextToSize(f.activity,150);s.text(I,120,g),g+=I.length*7}else g+=10;g+=10}else console.log("No entries found for the selected date");let b=s.lastAutoTable.finalY+(f?220:20);await me(s,b);const E=s.internal.getNumberOfPages();for(let g=1;g<=E;g++)s.setPage(g),s.setFontSize(10),s.setTextColor(100),s.text(`Sivu ${g} / ${E}`,20,s.internal.pageSize.height-10),s.text(`Luotu: ${new Date().toLocaleString("fi-FI")}`,s.internal.pageSize.width-20,s.internal.pageSize.height-10,{align:"right"});s.save(`HRV-raportti-${o}.pdf`),R("PDF-raportti luotu onnistuneesti!","success")}catch(o){console.error("Error generating PDF report:",o),R("Virhe raportin luonnissa!","error")}}async function me(e,t){try{let n=t,a=[],o=[];if(typeof fullRawData<"u"&&fullRawData?(a=fullRawData.slice(-7),o=fullRawData):typeof window.fullRawData<"u"&&window.fullRawData&&(a=window.fullRawData.slice(-7),o=window.fullRawData),!a.length&&!o.length&&(console.log("No data available in variables, fetching from API..."),a=await J(7),o=await J(30)),!a.length&&!o.length){console.log("No HRV data available for charts");return}const l=[{key:"heart_rate",label:"Syke",color:"#c62828"},{key:"rmssd",label:"RMSSD",color:"#2e7d32"},{key:"sdnn",label:"SDNN",color:"#1976d2"},{key:"pns_index",label:"PNS-indeksi",color:"#6a1b9a"},{key:"sns_index",label:"SNS-indeksi",color:"#c2185b"}],r=[{days:7,data:a},{days:30,data:o}];for(const c of r)if(c.data.length){n>240&&(e.addPage(),n=20),e.setFont("helvetica","bold"),e.setFontSize(16),e.text(`HRV-arvot (viimeiset ${c.days} päivää)`,20,n),n+=10;for(const i of l){n>230&&(e.addPage(),n=20);const d=await he(c.data,c.days,i);d&&(e.addImage(d,"PNG",20,n,120,40),n+=50)}n+=10}}catch(n){console.error("Error adding charts to report:",n)}}async function he(e,t,n){try{const a=document.createElement("div");a.style.width="600px",a.style.height="200px",a.style.position="fixed",a.style.top="-9999px";const o=document.createElement("canvas");o.width=600,o.height=200,a.appendChild(o),document.body.appendChild(a);const l=e.slice(-t);l.sort((u,s)=>{const h=u.daily_result?new Date(u.daily_result):new Date,m=s.daily_result?new Date(s.daily_result):new Date;return h-m});const r=l.map(u=>u.daily_result?new Date(u.daily_result).toLocaleDateString("fi-FI"):""),c=[{label:n.label,data:l.map(u=>u[n.key]),borderColor:n.color,backgroundColor:"transparent",borderWidth:2,fill:!1,tension:.4,pointRadius:3,pointHoverRadius:5}],i=o.getContext("2d");new Chart(i,{type:"line",data:{labels:r,datasets:c},options:{responsive:!1,maintainAspectRatio:!1,animation:!1,plugins:{title:{display:!0,text:n.label,font:{size:14,weight:"bold"}},legend:{display:!1},tooltip:{enabled:!1}},scales:{x:{ticks:{maxRotation:45,minRotation:45,callback:function(u,s){return s%(t>15?3:1)===0?this.getLabelForValue(u):""}}},y:{type:"linear",display:!0,beginAtZero:!1,ticks:{font:{size:10}}}}}}),await new Promise(u=>setTimeout(u,100));const d=o.toDataURL("image/png",.95);return document.body.removeChild(a),d}catch(a){return console.error(`Error generating ${n.key} chart:`,a),null}}
