(function(){const t=document.createElement("link").relList;if(t&&t.supports&&t.supports("modulepreload"))return;for(const o of document.querySelectorAll('link[rel="modulepreload"]'))s(o);new MutationObserver(o=>{for(const l of o)if(l.type==="childList")for(const c of l.addedNodes)c.tagName==="LINK"&&c.rel==="modulepreload"&&s(c)}).observe(document,{childList:!0,subtree:!0});function i(o){const l={};return o.integrity&&(l.integrity=o.integrity),o.referrerPolicy&&(l.referrerPolicy=o.referrerPolicy),o.crossOrigin==="use-credentials"?l.credentials="include":o.crossOrigin==="anonymous"?l.credentials="omit":l.credentials="same-origin",l}function s(o){if(o.ep)return;o.ep=!0;const l=i(o);fetch(o.href,l)}})();const f="http://72.145.13.207:5000/api";document.addEventListener("DOMContentLoaded",function(){console.log("Auth client script ladattu"),console.log("API URL on asetettu:",f);const e=document.getElementById("login-button"),t=document.getElementById("login-modal"),i=document.getElementById("close-modal"),s=document.getElementById("login-tab"),o=document.getElementById("login-form"),l=document.getElementById("login-error"),c=document.getElementById("user-menu-trigger");document.getElementById("user-menu-content");const y=document.getElementById("logoutButton"),p=document.getElementById("user-greeting");S(),e?(console.log("Login-nappi löytyi"),e.addEventListener("click",()=>{console.log("Login-nappia painettu"),t.style.display="block",w()})):console.warn("Login-nappia ei löytynyt DOM:sta"),i&&i.addEventListener("click",()=>{console.log("Sulje-nappia painettu"),t.style.display="none",k()}),window.addEventListener("click",a=>{a.target===t&&(console.log("Klikattu modalin ulkopuolelle, suljetaan"),t.style.display="none",k())}),s&&s.addEventListener("click",w),o?o.addEventListener("submit",I):console.warn("Login-lomaketta ei löytynyt DOM:sta"),y&&y.addEventListener("click",b);function w(){console.log("Näytetään login-lomake"),s.classList.add("active"),o.classList.add("active"),E()}function k(){console.log("Tyhjennetään lomakkeet"),o.reset(),E()}function E(){l&&(l.textContent="")}async function I(a){a.preventDefault(),console.log("Login-lomake lähetetty");const r=document.getElementById("login-username").value,n=document.getElementById("login-password").value;if(!r||!n){l.textContent="Käyttäjänimi ja salasana vaaditaan";return}console.log("Yritetään kirjautua käyttäjänimellä:",r);const u=o.querySelector('button[type="submit"]'),x=u.textContent;u.textContent="Kirjaudutaan...",u.disabled=!0;const v=`${f}/auth/login`;console.log("Login-päätepiste (täysi URL):",v);try{const m=await C(v,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({username:r,password:n})});if(!m)return;const h=await m.json();if(!m.ok){l.textContent=h.message||"Kirjautuminen epäonnistui",console.error("Kirjautuminen epäonnistui:",h.message);return}localStorage.setItem("user",JSON.stringify(h)),t.style.display="none",d(!0),await g()?window.location.href="diary.html":window.location.href="initial_info.html"}catch(m){console.error("Kirjautumisvirhe:",m),l.textContent="Palvelinvirhe, yritä myöhemmin uudelleen"}finally{u.textContent=x,u.disabled=!1}}function b(a){a.preventDefault(),console.log("Logging out user"),localStorage.removeItem("user"),setTimeout(()=>{window.location.href="index.html"},1e3),window.addEventListener("popstate",async function(){!await g()&&!window.location.pathname.includes("initial_info.html")&&(L("Täytä ensin esitietolomake","warning"),window.location.href="initial_info.html")}),d(!1),L("Olet kirjautunut ulos onnistuneesti","success"),window.location.pathname.includes("diary.html")?setTimeout(()=>{window.location.href="index.html"},1e3):setTimeout(()=>{window.location.reload()},1e3)}function S(){console.log("Checking authentication status");let a=null;try{a=JSON.parse(localStorage.getItem("user"))}catch{console.warn("Invalid user data in localStorage")}if(a&&a.token){const r=M(a.token),n=Math.floor(Date.now()/1e3);if(r&&r.exp&&r.exp<n){console.warn("Token is expired, logging out."),localStorage.removeItem("user"),d(!1);return}console.log("User is logged in:",a.user.given_name),d(!0),window.location.pathname.includes("initial_info.html")||j(),O()}else d(!1),(window.location.pathname.includes("diary.html")||window.location.pathname.includes("initial_info.html")||window.location.pathname.includes("myinfo.html"))&&(window.location.href="index.html")}function d(a){if(console.log("Updating UI for authentication status:",a),a){const r=JSON.parse(localStorage.getItem("user"));e&&(e.style.display="none",console.log("Login button hidden")),c?(c.style.display="flex",p&&(p.textContent=`Hei, ${r.user.given_name}!`),console.log("User menu displayed")):console.warn("User menu trigger not found");const n=document.getElementById("diary-nav-link");n?(n.style.display="inline",console.log("Diary nav link displayed")):console.warn("Diary nav link not found")}else{e&&(e.style.display="inline-block",console.log("Login button displayed")),y&&(y.style.display="none",console.log("Logout button hidden")),c&&(c.style.display="none",console.log("User menu hidden"));const r=document.getElementById("diary-nav-link");r&&(r.style.display="none",console.log("Diary nav link hidden"));const n=document.querySelector('a[href="/myinfo.html"]');n&&(n.parentElement.style.display="none",console.log("MyInfo nav link hidden"))}}function L(a,r="info"){let n=document.getElementById("status-message");n||(n=document.createElement("div"),n.id="status-message",n.style.position="fixed",n.style.top="20px",n.style.right="20px",n.style.padding="10px 20px",n.style.borderRadius="5px",n.style.zIndex="1000",n.style.boxShadow="0 2px 4px rgba(0,0,0,0.2)",document.body.appendChild(n)),n.textContent=a,r==="error"?(n.style.backgroundColor="#f44336",n.style.color="white"):r==="success"?(n.style.backgroundColor="#4CAF50",n.style.color="white"):(n.style.backgroundColor="#2196F3",n.style.color="white"),n.style.display="block",setTimeout(()=>{n.style.display="none"},3e3)}});function B(){const e=JSON.parse(localStorage.getItem("user"));return e?e.token:null}document.addEventListener("DOMContentLoaded",function(){const e=document.getElementById("login-modal"),t=document.querySelector(".hero-container"),i=document.getElementById("login-button"),s=document.getElementById("close-modal");i.addEventListener("click",function(){e.style.display="block",t.style.display="none"}),s.addEventListener("click",function(){e.style.display="none",t.style.display="block"}),window.addEventListener("click",function(o){o.target===e&&(e.style.display="none",t.style.display="block")})});async function C(e,t={}){const i=B(),s={...t.headers,Authorization:`Bearer ${i}`,"Content-Type":"application/json"};try{const o=await fetch(e,{...t,headers:s});return o.status===401?(console.warn("Token expired or unauthorized. Logging out."),localStorage.removeItem("user"),showMessage("Istunto vanhentunut. Kirjaudutaan ulos...","error"),setTimeout(()=>{window.location.href="index.html"},1500),null):o}catch(o){return console.error("secureFetch error:",o),showMessage("Palvelinvirhe, yritä myöhemmin uudelleen.","error"),null}}function M(e){try{const i=e.split(".")[1].replace(/-/g,"+").replace(/_/g,"/"),s=decodeURIComponent(atob(i).split("").map(function(o){return"%"+("00"+o.charCodeAt(0).toString(16)).slice(-2)}).join(""));return JSON.parse(s)}catch(t){return console.error("Failed to parse JWT token:",t),null}}async function g(){const e=JSON.parse(localStorage.getItem("user"));if(!e||!e.token)return!1;const t=e.user_id||e.id||e.userId||e.user&&e.user.id;try{let i=await fetch(`${f}/metrics/${t}`,{headers:{Authorization:`Bearer ${e.token}`}});if(i.status===404&&(i=await fetch(`${f}/metrics/user/${t}`,{headers:{Authorization:`Bearer ${e.token}`}})),i.status===404)return!1;if(!i.ok)return console.error("Error checking user status:",i.status),!1;const s=await i.json();return s&&s.length>0}catch(i){return console.error("Error checking user status:",i),!1}}async function j(){const e=window.location.pathname;!await g()&&(e.includes("diary.html")||e.includes("myinfo.html"))&&(showMessage("Täytä ensin esitietolomake","error"),window.location.href="initial_info.html")}async function O(){if(await g()){const t=document.querySelector('a[href="/index.html"]'),i=document.querySelector('a[href="/diary.html"]'),s=document.querySelector('a[href="/myinfo.html"]');t&&t.parentElement&&(t.parentElement.style.display=""),i&&i.parentElement&&(i.parentElement.style.display=""),s&&s.parentElement&&(s.parentElement.style.display="")}else{const t=document.querySelector('a[href="/diary.html"]'),i=document.querySelector('a[href="/myinfo.html"]'),s=document.querySelector('a[href="/index.html"]');s&&s.parentElement&&(s.parentElement.style.display="none"),t&&t.parentElement&&(t.parentElement.style.display="none"),i&&i.parentElement&&(i.parentElement.style.display="none")}}
