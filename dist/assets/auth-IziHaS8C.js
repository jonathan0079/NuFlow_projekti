(function(){const e=document.createElement("link").relList;if(e&&e.supports&&e.supports("modulepreload"))return;for(const n of document.querySelectorAll('link[rel="modulepreload"]'))i(n);new MutationObserver(n=>{for(const l of n)if(l.type==="childList")for(const c of l.addedNodes)c.tagName==="LINK"&&c.rel==="modulepreload"&&i(c)}).observe(document,{childList:!0,subtree:!0});function o(n){const l={};return n.integrity&&(l.integrity=n.integrity),n.referrerPolicy&&(l.referrerPolicy=n.referrerPolicy),n.crossOrigin==="use-credentials"?l.credentials="include":n.crossOrigin==="anonymous"?l.credentials="omit":l.credentials="same-origin",l}function i(n){if(n.ep)return;n.ep=!0;const l=o(n);fetch(n.href,l)}})();document.addEventListener("DOMContentLoaded",()=>{const t=document.getElementById("infoButton"),e=document.getElementById("infoModal"),o=document.getElementById("logininfoModal"),i=document.querySelector(".close-button");t.addEventListener("click",()=>{e.style.display="flex"}),t.addEventListener("click",()=>{OmaInfoModal.style.display="flex"}),t.addEventListener("click",()=>{o.style.display="flex"}),i.addEventListener("click",()=>{e.style.display="none"}),i.addEventListener("click",()=>{o.style.display="none"}),window.addEventListener("click",n=>{n.target===e&&(e.style.display="none")}),window.addEventListener("click",function(n){const l=document.getElementById("InfoModal");n.target===l&&l.classList.remove("show")}),window.addEventListener("click",function(n){const l=document.getElementById("logininfoModal");n.target===l&&(o.style.display="none")})});document.addEventListener("DOMContentLoaded",()=>{const t=document.getElementById("diaryInfoButton"),e=document.getElementById("diaryInfoModal"),o=document.querySelector(".close-button");t&&e&&t.addEventListener("click",()=>{e.classList.add("show")}),o&&e&&o.addEventListener("click",()=>{e.classList.remove("show")}),window.addEventListener("click",function(i){const n=document.getElementById("diaryInfoModal");i.target===n&&n.classList.remove("show")})});document.addEventListener("DOMContentLoaded",()=>{const t=document.getElementById("infoButton"),e=document.getElementById("OmaInfoModal");if(t&&e){t.addEventListener("click",()=>{e.style.display="flex"});const o=e.querySelector(".oma-close-button");o&&o.addEventListener("click",()=>{e.style.display="none"}),window.addEventListener("click",i=>{i.target===e&&(e.style.display="none")})}});document.addEventListener("DOMContentLoaded",()=>{const t=document.getElementById("settingsinfoButton"),e=document.getElementById("settingsinfoModal"),o=document.querySelector(".close-button");t.addEventListener("click",()=>{e.style.display="flex"}),o.addEventListener("click",()=>{e.style.display="none"}),window.addEventListener("click",function(i){const n=document.getElementById("settingsinfoModal");i.target===n&&(n.style.display="none")})});const p="https://nuflow-app.northeurope.cloudapp.azure.com/api";document.addEventListener("DOMContentLoaded",function(){const t=document.getElementById("login-button"),e=document.getElementById("login-modal"),o=document.getElementById("close-modal"),i=document.getElementById("login-tab"),n=document.getElementById("login-form"),l=document.getElementById("login-error"),c=document.getElementById("user-menu-trigger");document.getElementById("user-menu-content");const y=document.getElementById("logoutButton"),h=document.getElementById("user-greeting");B(),t?t.addEventListener("click",()=>{e.style.display="block",w()}):console.warn("Login-nappia ei löytynyt DOM:sta"),o&&o.addEventListener("click",()=>{e.style.display="none",E()}),window.addEventListener("click",r=>{r.target===e&&(e.style.display="none",E())}),i&&i.addEventListener("click",w),n?n.addEventListener("submit",v):console.warn("Login-lomaketta ei löytynyt DOM:sta"),y&&y.addEventListener("click",I);function w(){i.classList.add("active"),n.classList.add("active"),L()}function E(){n.reset(),L()}function L(){l&&(l.textContent="")}async function v(r){r.preventDefault();const a=document.getElementById("login-username").value,s=document.getElementById("login-password").value;if(!a||!s){l.textContent="Käyttäjänimi ja salasana vaaditaan";return}const u=n.querySelector('button[type="submit"]'),M=u.textContent;u.textContent="Kirjaudutaan...",u.disabled=!0;const b=`${p}/auth/login`;try{const m=await S(b,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({username:a,password:s})});if(!m)return;const g=await m.json();if(!m.ok){l.textContent=g.message||"Kirjautuminen epäonnistui",console.error("Kirjautuminen epäonnistui:",g.message);return}localStorage.setItem("user",JSON.stringify(g)),e.style.display="none",d(!0),await f()?window.location.href="diary.html":window.location.href="initial_info.html"}catch(m){console.error("Kirjautumisvirhe:",m),l.textContent="Palvelinvirhe, yritä myöhemmin uudelleen"}finally{u.textContent=M,u.disabled=!1}}function I(r){r.preventDefault(),localStorage.removeItem("user"),setTimeout(()=>{window.location.href="index.html"},1e3),window.addEventListener("popstate",async function(){!await f()&&!window.location.pathname.includes("initial_info.html")&&(k("Täytä ensin esitietolomake","warning"),window.location.href="initial_info.html")}),d(!1),k("Olet kirjautunut ulos onnistuneesti","success"),window.location.pathname.includes("diary.html")?setTimeout(()=>{window.location.href="index.html"},1e3):setTimeout(()=>{window.location.reload()},1e3)}function B(){let r=null;try{r=JSON.parse(localStorage.getItem("user"))}catch{console.warn("Invalid user data in localStorage")}if(r&&r.token){const a=O(r.token),s=Math.floor(Date.now()/1e3);if(a&&a.exp&&a.exp<s){console.warn("Token is expired, logging out."),localStorage.removeItem("user"),d(!1);return}d(!0),window.location.pathname.includes("initial_info.html")||C(),T()}else d(!1),(window.location.pathname.includes("diary.html")||window.location.pathname.includes("initial_info.html")||window.location.pathname.includes("myinfo.html"))&&(window.location.href="index.html")}function d(r){if(r){const a=JSON.parse(localStorage.getItem("user"));t&&(t.style.display="none"),c?(c.style.display="flex",h&&(h.textContent=`Hei, ${a.user.given_name}!`)):console.warn("User menu trigger not found");const s=document.getElementById("diary-nav-link");s?s.style.display="inline":console.warn("Diary nav link not found")}else{t&&(t.style.display="inline-block"),y&&(y.style.display="none"),c&&(c.style.display="none");const a=document.getElementById("diary-nav-link");a&&(a.style.display="none");const s=document.querySelector('a[href="/myinfo.html"]');s&&(s.parentElement.style.display="none")}}function k(r,a="info"){let s=document.getElementById("status-message");s||(s=document.createElement("div"),s.id="status-message",s.style.position="fixed",s.style.top="20px",s.style.right="20px",s.style.padding="10px 20px",s.style.borderRadius="5px",s.style.zIndex="1000",s.style.boxShadow="0 2px 4px rgba(0,0,0,0.2)",document.body.appendChild(s)),s.textContent=r,a==="error"?(s.style.backgroundColor="#f44336",s.style.color="white"):a==="success"?(s.style.backgroundColor="#4CAF50",s.style.color="white"):(s.style.backgroundColor="#2196F3",s.style.color="white"),s.style.display="block",setTimeout(()=>{s.style.display="none"},3e3)}});function x(){const t=JSON.parse(localStorage.getItem("user"));return t?t.token:null}document.addEventListener("DOMContentLoaded",function(){const t=document.getElementById("login-modal"),e=document.querySelector(".hero-container"),o=document.getElementById("login-button"),i=document.getElementById("close-modal");o.addEventListener("click",function(){t.style.display="block",e.style.display="none"}),i.addEventListener("click",function(){t.style.display="none",e.style.display="block"}),window.addEventListener("click",function(n){n.target===t&&(t.style.display="none",e.style.display="block")})});async function S(t,e={}){const o=x(),i={...e.headers,Authorization:`Bearer ${o}`,"Content-Type":"application/json"};try{const n=await fetch(t,{...e,headers:i});return n.status===401?(console.warn("Token expired or unauthorized. Logging out."),localStorage.removeItem("user"),showMessage("Istunto vanhentunut. Kirjaudutaan ulos...","error"),setTimeout(()=>{window.location.href="index.html"},1500),null):n}catch(n){return console.error("secureFetch error:",n),showMessage("Palvelinvirhe, yritä myöhemmin uudelleen.","error"),null}}function O(t){try{const o=t.split(".")[1].replace(/-/g,"+").replace(/_/g,"/"),i=decodeURIComponent(atob(o).split("").map(function(n){return"%"+("00"+n.charCodeAt(0).toString(16)).slice(-2)}).join(""));return JSON.parse(i)}catch(e){return console.error("Failed to parse JWT token:",e),null}}async function f(){const t=JSON.parse(localStorage.getItem("user"));if(!t||!t.token)return!1;const e=t.user_id||t.id||t.userId||t.user&&t.user.id;try{let o=await fetch(`${p}/metrics/${e}`,{headers:{Authorization:`Bearer ${t.token}`}});if(o.status===404&&(o=await fetch(`${p}/metrics/user/${e}`,{headers:{Authorization:`Bearer ${t.token}`}})),o.status===404)return!1;if(!o.ok)return console.error("Error checking user status:",o.status),!1;const i=await o.json();return i&&i.length>0}catch(o){return console.error("Error checking user status:",o),!1}}async function C(){const t=window.location.pathname;!await f()&&(t.includes("diary.html")||t.includes("myinfo.html"))&&(showMessage("Täytä ensin esitietolomake","error"),window.location.href="initial_info.html")}async function T(){if(await f()){const e=document.querySelector('a[href="/index.html"]'),o=document.querySelector('a[href="/diary.html"]'),i=document.querySelector('a[href="/myinfo.html"]');e&&e.parentElement&&(e.parentElement.style.display=""),o&&o.parentElement&&(o.parentElement.style.display=""),i&&i.parentElement&&(i.parentElement.style.display="")}else{const e=document.querySelector('a[href="/diary.html"]'),o=document.querySelector('a[href="/myinfo.html"]'),i=document.querySelector('a[href="/index.html"]');i&&i.parentElement&&(i.parentElement.style.display="none"),e&&e.parentElement&&(e.parentElement.style.display="none"),o&&o.parentElement&&(o.parentElement.style.display="none")}}
