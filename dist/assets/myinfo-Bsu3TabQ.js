import"./auth-IziHaS8C.js";/* empty css                     *//* empty css                */const m="https://nuflow-app.northeurope.cloudapp.azure.com/api";document.addEventListener("DOMContentLoaded",function(){const n=localStorage.getItem("user");if(!n){window.location.href="index.html";return}const e=JSON.parse(n);y(e),g();const t=e.user_id||e.id||e.userId;if(!t){console.error("User ID not found in user data"),a("Käyttäjätunnusta ei löydy, kirjaudu uudelleen sisään","error");return}h(t);const s=document.getElementById("submit-button");s&&s.addEventListener("click",p)});function g(){["birthday","email"].forEach(e=>{const t=document.getElementById(e);t&&(t.disabled=!0)})}function y(n){if(n&&n.user){const e=n.user,t=document.getElementById("first_name"),s=document.getElementById("last_name"),r=document.getElementById("birthday"),l=document.getElementById("height"),o=document.getElementById("weight"),u=document.getElementById("gender"),i=document.getElementById("email");if(e.given_name&&t&&(t.value=e.given_name),e.family_name&&s&&(s.value=e.family_name),e.birthdate&&r&&(r.value=e.birthdate),e.email&&i&&(i.value=e.email),e.height&&l){const d=Math.round(e.height*100);l.value=d}if(e.weight&&o&&(o.value=e.weight),e.gender&&u){let d=e.gender;e.gender==="male"?d="mies":e.gender==="female"?d="nainen":e.gender==="other"&&(d="muu"),u.value=d}}}async function h(n){try{const e=f();if(!e){console.error("Auth token not found");return}let t=await fetch(`${m}/metrics/${n}`,{method:"GET",headers:{Authorization:`Bearer ${e}`}});if(t.status===404&&(t=await fetch(`${m}/metrics/user/${n}`,{method:"GET",headers:{Authorization:`Bearer ${e}`}})),!t.ok){console.error("Failed to fetch health metrics:",t.status);return}const s=await t.json();if(s&&s.length>0){const r=s[0];document.getElementById("drug_use").value=r.drug_use||"",document.getElementById("drug_use").placeholder="Kerro käyttämistäsi päihteistä...",document.getElementById("diseases_medications").value=r.diseases_medications||"",document.getElementById("diseases_medications").placeholder="Kerro sairauksistasi ja lääkityksistäsi...",document.getElementById("sleep").value=r.sleep||"",document.getElementById("sleep").placeholder="Kerro unen laadusta...",document.getElementById("self_assessment").value=r.self_assessment||"",document.getElementById("self_assessment").placeholder="Kerro tämänhetkisestä voinnistasi..."}}catch(e){console.error("Error fetching health metrics:",e)}}async function p(n){n.preventDefault();try{const e=localStorage.getItem("user");if(!e){a("Et ole kirjautunut sisään","error");return}const t=JSON.parse(e),s=t.user_id||t.id||t.userId;if(!s){a("Käyttäjätunnusta ei löydy","error");return}const r={user_id:s,drug_use:document.getElementById("drug_use").value,diseases_medications:document.getElementById("diseases_medications").value,sleep:document.getElementById("sleep").value,self_assessment:document.getElementById("self_assessment").value},l=f();if(!l){console.error("Auth token not found"),a("Kirjautumistietoja ei löydy","error");return}let o;try{o=await fetch(`${m}/metrics/${s}`,{method:"GET",headers:{Authorization:`Bearer ${l}`}}),o.status===404&&(o=await fetch(`${m}/metrics/user/${s}`,{method:"GET",headers:{Authorization:`Bearer ${l}`}}))}catch(i){console.error("Error fetching metrics:",i)}let u;if(o&&o.ok){const i=await o.json();if(i&&i.length>0){const c=i[0].metric_id;(await fetch(`${m}/metrics/${c}`,{method:"PUT",headers:{"Content-Type":"application/json",Authorization:`Bearer ${l}`},body:JSON.stringify(r)})).ok?a("Tiedot päivitetty onnistuneesti!","success"):a("Tietojen päivitys epäonnistui","error")}else u=await fetch(`${m}/metrics/insert`,{method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${l}`},body:JSON.stringify(r)}),u.ok?a("Tiedot tallennettu onnistuneesti!","success"):a("Tietojen tallennus epäonnistui","error")}else u=await fetch(`${m}/metrics/insert`,{method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${l}`},body:JSON.stringify(r)}),u.ok?a("Tiedot tallennettu onnistuneesti!","success"):a("Tietojen tallennus epäonnistui","error");await E(),h(s)}catch(e){console.error("Error submitting form:",e),a("Virhe lomakkeen lähetyksessä","error")}}async function E(){try{const n=localStorage.getItem("user");if(!n)return;const e=JSON.parse(n);if(!e.token)return;const t=document.getElementById("first_name").value,s=document.getElementById("last_name").value,r=parseFloat(document.getElementById("height").value)/100,l=parseFloat(document.getElementById("weight").value);let o=document.getElementById("gender").value.toLowerCase();o==="mies"?o="male":o==="nainen"?o="female":o==="muu"&&(o="other");const u=e.user||{},i={};if(t&&t!==u.given_name&&(i.given_name=t),s&&s!==u.family_name&&(i.family_name=s),r&&r!==u.height&&(i.height=r),l&&l!==u.weight&&(i.weight=l),o&&o!==u.gender&&(i.gender=o),Object.keys(i).length>0){const d=await fetch(`${m}/kubios/userinfo`,{method:"PATCH",headers:{"Content-Type":"application/json",Authorization:`Bearer ${e.token}`},body:JSON.stringify(i)});if(d.ok){const c={...e};c.user&&(c.user={...c.user,...i},localStorage.setItem("user",JSON.stringify(c))),a("Profiili päivitetty onnistuneesti!","success")}else{console.error("Failed to update Kubios profile:",d.status);const c=await d.json().catch(()=>({}));console.error("Error details:",c),a("Profiilin päivitys epäonnistui","error")}}}catch(n){console.error("Error updating Kubios profile:",n),a("Virhe profiilin päivityksessä","error")}}function f(){try{const n=localStorage.getItem("user");return n?JSON.parse(n).token:null}catch(n){return console.error("Error getting auth token:",n),null}}function a(n,e="info"){let t=document.getElementById("status-message");t||(t=document.createElement("div"),t.id="status-message",t.style.position="fixed",t.style.top="20px",t.style.right="20px",t.style.padding="10px 20px",t.style.borderRadius="5px",t.style.zIndex="1000",t.style.boxShadow="0 2px 4px rgba(0,0,0,0.2)",document.body.appendChild(t)),t.textContent=n,e==="error"?(t.style.backgroundColor="#f44336",t.style.color="white"):e==="success"?(t.style.backgroundColor="#4CAF50",t.style.color="white"):(t.style.backgroundColor="#2196F3",t.style.color="white"),t.style.display="block",setTimeout(()=>{t.style.display="none"},3e3)}
