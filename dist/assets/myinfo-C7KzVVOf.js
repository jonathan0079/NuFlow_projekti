import"./auth-CgT9UiaM.js";/* empty css                     *//* empty css                */import"./opastus-B5Ddp_SE.js";const m="http://72.145.13.207:5000/api";document.addEventListener("DOMContentLoaded",function(){console.log("myinfo.js loaded");const o=localStorage.getItem("user");if(!o){console.log("User not logged in, redirecting to index.html"),window.location.href="index.html";return}const e=JSON.parse(o);console.log("User data from localStorage:",e),y(e),f();const t=e.user_id||e.id||e.userId;if(!t){console.error("User ID not found in user data"),a("Käyttäjätunnusta ei löydy, kirjaudu uudelleen sisään","error");return}console.log("User ID:",t),g(t);const n=document.getElementById("submit-button");n&&n.addEventListener("click",p)});function f(){["birthday","email"].forEach(e=>{const t=document.getElementById(e);t&&(t.disabled=!0)})}function y(o){if(o&&o.user){const e=o.user;console.log("Kubios user data:",e);const t=document.getElementById("first_name"),n=document.getElementById("last_name"),r=document.getElementById("birthday"),l=document.getElementById("height"),s=document.getElementById("weight"),u=document.getElementById("gender"),i=document.getElementById("email");if(e.given_name&&t&&(t.value=e.given_name),e.family_name&&n&&(n.value=e.family_name),e.birthdate&&r&&(r.value=e.birthdate),e.email&&i&&(i.value=e.email),e.height&&l){const d=Math.round(e.height*100);l.value=d}if(e.weight&&s&&(s.value=e.weight),e.gender&&u){let d=e.gender;e.gender==="male"?d="mies":e.gender==="female"?d="nainen":e.gender==="other"&&(d="muu"),u.value=d}}}async function g(o){try{console.log("Fetching health metrics for user ID:",o);const e=h();if(!e){console.error("Auth token not found");return}let t=await fetch(`${m}/metrics/${o}`,{method:"GET",headers:{Authorization:`Bearer ${e}`}});if(t.status===404&&(console.log("First endpoint returned 404, trying alternate endpoint"),t=await fetch(`${m}/metrics/user/${o}`,{method:"GET",headers:{Authorization:`Bearer ${e}`}})),!t.ok){console.error("Failed to fetch health metrics:",t.status);return}const n=await t.json();if(console.log("Health metrics data:",n),n&&n.length>0){const r=n[0];document.getElementById("drug_use").value=r.drug_use||"",document.getElementById("drug_use").placeholder="Kerro käyttämistäsi päihteistä...",document.getElementById("diseases_medications").value=r.diseases_medications||"",document.getElementById("diseases_medications").placeholder="Kerro sairauksistasi ja lääkityksistäsi...",document.getElementById("sleep").value=r.sleep||"",document.getElementById("sleep").placeholder="Kerro unen laadusta...",document.getElementById("self_assessment").value=r.self_assessment||"",document.getElementById("self_assessment").placeholder="Kerro tämänhetkisestä voinnistasi..."}}catch(e){console.error("Error fetching health metrics:",e)}}async function p(o){o.preventDefault();try{const e=localStorage.getItem("user");if(!e){a("Et ole kirjautunut sisään","error");return}const t=JSON.parse(e),n=t.user_id||t.id||t.userId;if(!n){a("Käyttäjätunnusta ei löydy","error");return}const r={user_id:n,drug_use:document.getElementById("drug_use").value,diseases_medications:document.getElementById("diseases_medications").value,sleep:document.getElementById("sleep").value,self_assessment:document.getElementById("self_assessment").value};console.log("Submitting metric data:",r);const l=h();if(!l){console.error("Auth token not found"),a("Kirjautumistietoja ei löydy","error");return}let s;try{s=await fetch(`${m}/metrics/${n}`,{method:"GET",headers:{Authorization:`Bearer ${l}`}}),s.status===404&&(s=await fetch(`${m}/metrics/user/${n}`,{method:"GET",headers:{Authorization:`Bearer ${l}`}}))}catch(i){console.error("Error fetching metrics:",i)}let u;if(s&&s.ok){const i=await s.json();if(i&&i.length>0){const c=i[0].metric_id;(await fetch(`${m}/metrics/${c}`,{method:"PUT",headers:{"Content-Type":"application/json",Authorization:`Bearer ${l}`},body:JSON.stringify(r)})).ok?a("Tiedot päivitetty onnistuneesti!","success"):a("Tietojen päivitys epäonnistui","error")}else u=await fetch(`${m}/metrics/insert`,{method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${l}`},body:JSON.stringify(r)}),u.ok?a("Tiedot tallennettu onnistuneesti!","success"):a("Tietojen tallennus epäonnistui","error")}else u=await fetch(`${m}/metrics/insert`,{method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${l}`},body:JSON.stringify(r)}),u.ok?a("Tiedot tallennettu onnistuneesti!","success"):a("Tietojen tallennus epäonnistui","error");await E(),g(n)}catch(e){console.error("Error submitting form:",e),a("Virhe lomakkeen lähetyksessä","error")}}async function E(){try{const o=localStorage.getItem("user");if(!o)return;const e=JSON.parse(o);if(!e.token)return;const t=document.getElementById("first_name").value,n=document.getElementById("last_name").value,r=parseFloat(document.getElementById("height").value)/100,l=parseFloat(document.getElementById("weight").value);let s=document.getElementById("gender").value.toLowerCase();s==="mies"?s="male":s==="nainen"?s="female":s==="muu"&&(s="other");const u=e.user||{},i={};if(t&&t!==u.given_name&&(i.given_name=t),n&&n!==u.family_name&&(i.family_name=n),r&&r!==u.height&&(i.height=r),l&&l!==u.weight&&(i.weight=l),s&&s!==u.gender&&(i.gender=s),Object.keys(i).length>0){console.log("Updating Kubios profile:",i);const d=await fetch(`${m}/kubios/userinfo`,{method:"PATCH",headers:{"Content-Type":"application/json",Authorization:`Bearer ${e.token}`},body:JSON.stringify(i)});if(d.ok){console.log("Kubios profile updated successfully");const c={...e};c.user&&(c.user={...c.user,...i},localStorage.setItem("user",JSON.stringify(c))),a("Profiili päivitetty onnistuneesti!","success")}else{console.error("Failed to update Kubios profile:",d.status);const c=await d.json().catch(()=>({}));console.error("Error details:",c),a("Profiilin päivitys epäonnistui","error")}}}catch(o){console.error("Error updating Kubios profile:",o),a("Virhe profiilin päivityksessä","error")}}function h(){try{const o=localStorage.getItem("user");return o?JSON.parse(o).token:null}catch(o){return console.error("Error getting auth token:",o),null}}function a(o,e="info"){let t=document.getElementById("status-message");t||(t=document.createElement("div"),t.id="status-message",t.style.position="fixed",t.style.top="20px",t.style.right="20px",t.style.padding="10px 20px",t.style.borderRadius="5px",t.style.zIndex="1000",t.style.boxShadow="0 2px 4px rgba(0,0,0,0.2)",document.body.appendChild(t)),t.textContent=o,e==="error"?(t.style.backgroundColor="#f44336",t.style.color="white"):e==="success"?(t.style.backgroundColor="#4CAF50",t.style.color="white"):(t.style.backgroundColor="#2196F3",t.style.color="white"),t.style.display="block",setTimeout(()=>{t.style.display="none"},3e3)}
